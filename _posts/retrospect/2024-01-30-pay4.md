---
title: Vueì™€ Springì„ ì´ìš©í•œ ê°„í¸ê²°ì œ ì ìš©ê¸° 4
categories: [Retrospect]
tags: ['ê°„í¸ê²°ì œ', 'í† ìŠ¤í˜ì´', 'ì¹´ì¹´ì˜¤í˜ì´', 'tosspay', 'kakaopay', 'feign']
toc: true

date: 2024-01-30
last_modified_at: 2024-01-30
---

## 1. ë“¤ì–´ê°€ê¸°

ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œëŠ” enumì„ ì´ìš©í•´ ë¶„ë¦¬í•œ ì„œë¹„ìŠ¤ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì—°ê²°í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” Feign Clientë¥¼ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— í¬í•¨ë˜ì–´ ìˆëŠ” HTTP í†µì‹  ë¡œì§ì„ ë¶„ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤.

## 2. Feign Client ì˜ì¡´ì„± ì¶”ê°€

build.gradle íŒŒì¼ì„ ì—´ì–´ì„œ ì˜ì¡´ì„±ì„ ì¶”ê°€í•©ì‹œë‹¤.

```groovy
  ext {
    set('springCloudVersion', "2022.0.3")
  }

  dependencies {
    implementation "org.springframework.cloud:spring-cloud-starter-openfeign"
  }

  ...
  dependencyManagement {
      imports {
          mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
      }
  }
```

> Spring Cloud Version í™•ì¸
>
> [https://spring.io/projects/spring-cloud](https://spring.io/projects/spring-cloud){:target="_blank"}

## 3. Feign Client ì¸í„°í˜ì´ìŠ¤ ìƒì„±

application.yml íŒŒì¼ì„ ì—´ì–´ì„œ í† ìŠ¤í˜ì´ì™€ ì¹´ì¹´ì˜¤í˜ì´ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì„¸íŒ…í•©ë‹ˆë‹¤.

```yaml
# application.yml
  easy-pay:
    toss:
      url: https://pay.toss.im/api/v2
    kakao:
      url: https://kapi.kakao.com/v1/payment
```

ê·¸ë¦¬ê³  ê°„í¸ê²°ì œ ë³„ë¡œ Client ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```java
// TossPayClient.java
  @FeignClient(value = "toss-client", url = "${easy-pay.toss.url}")
  public interface TossPayClient {

    @PostMapping(value = "/payments", consumes = MediaType.APPLICATION_JSON_VALUE)
    JSONObject request(@RequestBody TossPayRequest payRequest);

    @PostMapping(value = "/execute", consumes = MediaType.APPLICATION_JSON_VALUE)
    JSONObject approve(@RequestBody TossPayRequest payRequest);
  }
```

```java
// KakaoPayClient.java
  @FeignClient(value = "kakao-client", url = "${easy-pay.kakao.url}")
  public interface KakaoPayClient {

    @PostMapping(value = "/ready", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
    JSONObject request(@RequestHeader("Authorization") String authorization, @RequestBody KakaoPayRequest request);

    @PostMapping(value = "/approve", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
    JSONObject approve(@RequestHeader("Authorization") String authorization, @RequestBody KakaoPayRequest request);
  }
```

í•œ ê°€ì§€ ì£¼ì˜í•  ì ì€ ì¹´ì¹´ì˜¤í˜ì´ì˜ ë°ì´í„°ëŠ” Camel Caseê°€ ì•„ë‹Œ Snake Caseì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ, JavaëŠ” ë„¤ì´ë° ë£°ë¡œ Camel Caseë¥¼ ì‚¬ìš©í•˜ëŠ”ë°ìš”.

ì´ëŸ´ ë• Feign ìš”ì²­ ì‹œ Snake Caseë¡œ ë³€í™˜í•˜ì—¬ ìš”ì²­í•˜ë„ë¡ í•˜ë©´ ë©ë‹ˆë‹¤.

ì´ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
// KakaoPayRequest.java
  @Builder
  public class KakaoPayRequest {

      /** ê²°ì œ ìŠ¹ì¸ ìš”ì²­ í† í° */
      @FormProperty("pg_token")
      private String pgToken;

      ...
  }
```

```java
// FeignSnakeCaseConfiguration.java
  public class FeignSnakeCaseConfiguration {

    // Feign ìš”ì²­ ì‹œ FormProperty ê°’ìœ¼ë¡œ encode
    @Bean
    Encoder feignFormEncoder() {
      return new FormEncoder();
    }
  }
```

```java
  configuration = FeignSnakeCaseConfiguration.class
```

ì¢…í•©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```java
// KakaoPayClient.java
  @FeignClient(value = "kakao-client", url = "${easy-pay.kakao.url}", configuration = FeignSnakeCaseConfiguration.class)
  public interface KakaoPayClient {

    @PostMapping(value = "/ready", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
    JSONObject request(@RequestHeader("Authorization") String authorization, @RequestBody KakaoPayRequest request);

    @PostMapping(value = "/approve", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
    JSONObject approve(@RequestHeader("Authorization") String authorization, @RequestBody KakaoPayRequest request);
  }
```

## 4. HTTP í†µì‹  ë¡œì§ ë¶„ë¦¬

Feign Client ì¸í„°í˜ì´ìŠ¤ë„ ìƒì„±í–ˆìœ¼ë‹ˆ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ HTTP í†µì‹  ë¡œì§ì„ ë¶„ë¦¬í•´ë´…ì‹œë‹¤.

ê¸°ì¡´ ì½”ë“œì…ë‹ˆë‹¤.

```java
  @Override
  public JSONObject request(EasyPay easyPay) {
    try {
      // Connection
      URL url = new URL("https://pay.toss.im/api/v2/payments");
      URLConnection connection = url.openConnection();
      connection.addRequestProperty("Content-Type", "application/json");
      connection.setDoOutput(true);
      connection.setDoInput(true);

      // ë°ì´í„° ìƒì„±
      JSONObject jsonBody = new JSONObject();
      jsonBody.put("orderNo", createOrderNo());
      jsonBody.put("amount", easyPay.getProductPrice());
      jsonBody.put("amountTaxFree", "0");
      jsonBody.put("productDesc", easyPay.getProductName());
      jsonBody.put("apiKey", apiKey);
      jsonBody.put("autoExecute", false);
      jsonBody.put("retUrl", frontUrl + "/easy-pay/order-check/toss");
      jsonBody.put("retCancelUrl", frontUrl + "/easy-pay/close");

      // ìš”ì²­
      BufferedOutputStream bos = new BufferedOutputStream(connection.getOutputStream());

      bos.write(jsonBody.toJSONString().getBytes(StandardCharsets.UTF_8));
      bos.flush();
      bos.close();

      // JSONObjectì— ë§¤í•‘
      BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8));
      JSONParser jsonParser = new JSONParser();
      JSONObject result = (JSONObject) jsonParser.parse(br.readLine());

      br.close();
      return result;
    } catch (Exception e) {
      return null;
    }
  }
```

HTTP í†µì‹  ë¡œì§ì„ ë¶„ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```java
  @Override
  public JSONObject request(EasyPay easyPay) {
    TossPayRequest data = TossPayRequest.builder()
                                        .orderNo(createOrderNo())
                                        .amount(easyPay.getProductPrice())
                                        .amountTaxFree("0")
                                        .productDesc(easyPay.getProductName())
                                        .apiKey(apiKey)
                                        .autoExecute(Boolean.toString(false))
                                        .retUrl(frontUrl + "/easy-pay/order-check/toss")
                                        .retCancelUrl(frontUrl + "/easy-pay/close")
                                        .build();

    return tossPayClient.request(data);
  }
```

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ í™•ì‹¤íˆ ê¹”ë”í•´ì§„ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 5. ì •ë¦¬

ì—¬ê¸°ê¹Œì§€ ê¸°ì¡´ ì½”ë“œë¥¼ ê°€ë…ì„±ê³¼ í™•ì¥ì„±ì„ ê³ ë ¤í•´ ë¦¬íŒ©í† ë§ í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

ë§Œì•½, í˜ì´ì½” ê°„í¸ê²°ì œë¥¼ ì¶”ê°€í•˜ë ¤ë©´ enumì— `PAYCO(PaycoService.class)`ë¥¼ ì¶”ê°€í•˜ê³ 

`EasyPayService` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” `PaycoService`ë¥¼ ìƒì„±í•˜ë©´ í¸ë¦¬í•˜ê²Œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

ğŸš© ë¦¬íŒ©í† ë§ì— ë„ì›€ ì£¼ì‹  ì¥ì§€ì˜ ë§¤ë‹ˆì €ë‹˜, ì´ì¬ë ¬ ë§¤ë‹ˆì €ë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜Š